# Este flujo de trabajo construye un proyecto Java con Maven y utiliza la sabidur√≠a de los antiguos para el an√°lisis
# Por medio de las artes de la inteligencia artificial, se examinan los frutos de las pruebas
# Y se deja constancia de los hallazgos en las cr√≥nicas del repositorio

name: An√°lisis de Calidad con Maven e IA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'N√∫mero de la issue donde comentar el an√°lisis'
        required: false
        default: '7'
        type: string

jobs:
  # Primer oficio: Forjar el c√≥digo y ejecutar las pruebas sagradas
  build-and-test:
    name: üî® Construcci√≥n y Pruebas del C√≥dice
    runs-on: ubuntu-latest
    outputs:
      tests-total: ${{ steps.extract-metrics.outputs.tests-total }}
      tests-errors: ${{ steps.extract-metrics.outputs.tests-errors }}
      tests-failures: ${{ steps.extract-metrics.outputs.tests-failures }}
      coverage-percentage: ${{ steps.extract-coverage.outputs.coverage }}

    steps:
    - name: Obtener los pergaminos del repositorio
      uses: actions/checkout@v4

    - name: Preparar las herramientas de Java, como los antiguos maestros
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Forjar con Maven y ejecutar las pruebas de la sabidur√≠a
      run: |
        echo "üî® Iniciando la construcci√≥n y pruebas del c√≥dice..." >> $GITHUB_STEP_SUMMARY
        mvn clean test
        echo "‚úÖ Construcci√≥n y pruebas completadas exitosamente" >> $GITHUB_STEP_SUMMARY

    - name: Extraer las m√©tricas de las pruebas realizadas
      id: extract-metrics
      run: |
        total=$(grep -o 'tests="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        errors=$(grep -o 'errors="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        failures=$(grep -o 'failures="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        echo "tests-total=$total" >> $GITHUB_OUTPUT
        echo "tests-errors=$errors" >> $GITHUB_OUTPUT
        echo "tests-failures=$failures" >> $GITHUB_OUTPUT
        failed=$((errors + failures))
        if [ "$total" -eq 0 ]; then
          echo "‚ùå No se hallaron pruebas en los pergaminos." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        percent=$((100 * failed / total))
        echo "üß™ M√©tricas extra√≠das de las pruebas:" >> $GITHUB_STEP_SUMMARY
        echo "- Total de pruebas: $total" >> $GITHUB_STEP_SUMMARY
        echo "- Errores: $errors" >> $GITHUB_STEP_SUMMARY
        echo "- Fallos: $failures" >> $GITHUB_STEP_SUMMARY
        echo "- Porcentaje de fallos: $percent%" >> $GITHUB_STEP_SUMMARY
        if [ "$percent" -gt 10 ]; then
          echo "‚ö†Ô∏è El porcentaje de errores supera el l√≠mite establecido por los antiguos sabios (10%)." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Generar el reporte de cobertura con las artes de Jacoco
      run: |
        echo "üìä Generando reporte de cobertura con Jacoco..." >> $GITHUB_STEP_SUMMARY
        mvn jacoco:report
        echo "‚úÖ Reporte de cobertura generado exitosamente" >> $GITHUB_STEP_SUMMARY

    - name: Extraer la cobertura de c√≥digo
      id: extract-coverage
      run: |
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          coverage=$(grep -o 'type="INSTRUCTION".*counter' target/site/jacoco/jacoco.xml | grep -o 'covered="[0-9]\+"' | head -1 | grep -o '[0-9]\+')
          total=$(grep -o 'type="INSTRUCTION".*counter' target/site/jacoco/jacoco.xml | grep -o 'missed="[0-9]\+"' | head -1 | grep -o '[0-9]\+')
          if [ -n "$coverage" ] && [ -n "$total" ]; then
            percent=$((100 * coverage / (coverage + total)))
            echo "coverage=$percent" >> $GITHUB_OUTPUT
            echo "üìä Cobertura de c√≥digo extra√≠da exitosamente:" >> $GITHUB_STEP_SUMMARY
            echo "- Porcentaje de cobertura: $percent%" >> $GITHUB_STEP_SUMMARY
            echo "- Instrucciones cubiertas: $coverage" >> $GITHUB_STEP_SUMMARY
            echo "- Instrucciones totales: $((coverage + total))" >> $GITHUB_STEP_SUMMARY
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No se pudieron extraer m√©tricas de cobertura" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
          echo "‚ùå No se encontr√≥ el archivo de reporte Jacoco" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Preservar los resultados de las pruebas para la posteridad
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: resultados-pruebas-y-cobertura
        path: |
          target/surefire-reports/
          target/site/jacoco/
          
    - name: Reportar la preservaci√≥n de artefactos
      if: always()
      run: |
        echo "üì¶ Artefactos preservados exitosamente:" >> $GITHUB_STEP_SUMMARY
        echo "- Reportes de pruebas (Surefire)" >> $GITHUB_STEP_SUMMARY
        echo "- Reportes de cobertura (Jacoco)" >> $GITHUB_STEP_SUMMARY
        echo "- Nombre del artefacto: resultados-pruebas-y-cobertura" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üîç Archivos que se incluir√°n en el artefacto:" >> $GITHUB_STEP_SUMMARY
        echo "**Surefire Reports:**" >> $GITHUB_STEP_SUMMARY
        if [ -d "target/surefire-reports" ]; then
          ls target/surefire-reports/TEST-*.xml 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "No se encontraron archivos TEST-*.xml" >> $GITHUB_STEP_SUMMARY
        fi
        echo "**Jacoco Reports:**" >> $GITHUB_STEP_SUMMARY
        if [ -d "target/site/jacoco" ]; then
          ls target/site/jacoco/jacoco.xml 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No se encontr√≥ jacoco.xml" >> $GITHUB_STEP_SUMMARY
          ls target/site/jacoco/jacoco.csv 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No se encontr√≥ jacoco.csv" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generar la insignia de Jacoco como los heraldos de anta√±o
      id: jacoco-badge
      uses: cicirello/jacoco-badge-generator@v2
      with:
        jacoco-csv-file: target/site/jacoco/jacoco.csv
        badges-directory: .github/badges
        
    - name: Reportar la creaci√≥n de insignias en las cr√≥nicas
      run: |
        echo "üèÖ Insignia de Jacoco generada exitosamente" >> $GITHUB_STEP_SUMMARY
        echo "üìä Cobertura reportada: ${{ steps.extract-coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
        echo "üìç Ubicaci√≥n: .github/badges/jacoco.svg" >> $GITHUB_STEP_SUMMARY
        if [ -f ".github/badges/jacoco.svg" ]; then
          echo "‚úÖ Archivo de insignia creado correctamente" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Error: Archivo de insignia no encontrado" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Grabar la insignia en los anales del repositorio
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        if [ -f ".github/badges/jacoco.svg" ]; then
          git add .github/badges/jacoco.svg
          if git diff --staged --quiet; then
            echo "üìù Sin cambios en la insignia - mantiene el estado anterior" >> $GITHUB_STEP_SUMMARY
          else
            git commit -m "Actualiza insignia de cobertura Jacoco [skip ci]"
            git push
            echo "‚úÖ Insignia actualizada y guardada en los anales" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ö†Ô∏è No se pudo encontrar la insignia para grabar" >> $GITHUB_STEP_SUMMARY
        fi

  # Segundo oficio: Preparar los datos para el an√°lisis de la IA
  prepare-data:
    name: üìú Preparaci√≥n de los Pergaminos
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
    outputs:
      xml-content: ${{ steps.read-xml.outputs.XML_CONTENT }}
      coverage-content: ${{ steps.read-coverage.outputs.COVERAGE_CONTENT }}
      file-exists: ${{ steps.check-files.outputs.exists }}
    steps:
      - name: Obtener los pergaminos del repositorio
        uses: actions/checkout@v4
      
      - name: Descargar los artefactos de las pruebas
        uses: actions/download-artifact@v4
        with:
          name: resultados-pruebas-y-cobertura
          path: target/
      
      - name: Reportar la descarga de pergaminos
        run: |
          echo "üì• Artefactos descargados exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "üìÇ Contenido descargado en: target/" >> $GITHUB_STEP_SUMMARY
          if [ -d "target" ]; then
            file_count=$(find target -type f | wc -l)
            echo "üìÑ Archivos encontrados: $file_count" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîç Estructura de directorios:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tree target/ 2>/dev/null || find target -type f | head -10 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Verificar la existencia de los pergaminos de pruebas
        id: check-files
        run: |
          if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Pergaminos de pruebas hallados" >> $GITHUB_STEP_SUMMARY
            file_count=$(ls target/surefire-reports/TEST-*.xml | wc -l)
            echo "üìÑ Archivos XML encontrados: $file_count" >> $GITHUB_STEP_SUMMARY
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Pergaminos de pruebas extraviados" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Leer el contenido de los pergaminos XML
        id: read-xml
        run: |
          if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
            # Crear un resumen del contenido XML en lugar de todo el contenido
            {
              echo "XML_CONTENT<<GITHUB_XML_END_OF_CONTENT"
              echo "=== RESUMEN DE PERGAMINOS XML ==="
              echo "Archivos encontrados: $(ls target/surefire-reports/TEST-*.xml | wc -l)"
              echo ""
              echo "=== CONTENIDO DE LOS PRIMEROS 3 ARCHIVOS ==="
              ls target/surefire-reports/TEST-*.xml | head -3 | while read file; do
                echo "--- ARCHIVO: $file ---"
                head -50 "$file"  # Solo primeras 50 l√≠neas de cada archivo
                echo ""
              done
              echo "GITHUB_XML_END_OF_CONTENT"
            } >> $GITHUB_OUTPUT
            xml_count=$(ls target/surefire-reports/TEST-*.xml | wc -l)
            echo "‚úÖ $xml_count pergaminos XML procesados (resumen generado)" >> $GITHUB_STEP_SUMMARY
          else
            echo "XML_CONTENT=No se encontraron pergaminos de pruebas" >> $GITHUB_OUTPUT
          fi

      - name: Leer el contenido del reporte de cobertura
        id: read-coverage
        run: |
          if [ -f "target/site/jacoco/jacoco.xml" ]; then
            {
              echo "COVERAGE_CONTENT<<GITHUB_COVERAGE_END_OF_CONTENT"
              echo "=== REPORTE DE COBERTURA JACOCO ==="
              echo "Archivo: target/site/jacoco/jacoco.xml"
              echo ""
              # Tomar solo las partes m√°s relevantes del XML de cobertura
              head -100 target/site/jacoco/jacoco.xml
              echo ""
              echo "=== ESTAD√çSTICAS DE COBERTURA ==="
              grep -E "(counter|package|class)" target/site/jacoco/jacoco.xml | head -20
              echo "GITHUB_COVERAGE_END_OF_CONTENT"
            } >> $GITHUB_OUTPUT
            echo "‚úÖ Pergamino de cobertura procesado (resumen generado)" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ Ubicaci√≥n: target/site/jacoco/jacoco.xml" >> $GITHUB_STEP_SUMMARY
          else
            echo "COVERAGE_CONTENT=No se encontr√≥ el pergamino de cobertura" >> $GITHUB_OUTPUT
            echo "‚ùå Pergamino de cobertura no encontrado en target/site/jacoco/jacoco.xml" >> $GITHUB_STEP_SUMMARY
            # Buscar en ubicaciones alternativas y diagnosticar
            echo "üîç Buscando archivos de cobertura en ubicaciones alternativas..." >> $GITHUB_STEP_SUMMARY
            echo "üìÇ Explorando estructura completa del directorio target:" >> $GITHUB_STEP_SUMMARY
            find target -name "*.xml" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No se encontraron archivos XML" >> $GITHUB_STEP_SUMMARY
            find target -name "jacoco*" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No se encontraron archivos de Jacoco" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Finalizar la preparaci√≥n de pergaminos
        run: |
          echo "üìã Resumen de la preparaci√≥n:" >> $GITHUB_STEP_SUMMARY
          echo "- Pergaminos XML: ${{ steps.check-files.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pergamino de cobertura: ${{ steps.read-coverage.outputs.COVERAGE_CONTENT != 'No se encontr√≥ el pergamino de cobertura' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Estado: Preparaci√≥n completada para el an√°lisis de IA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîç Diagn√≥stico final:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-files.outputs.exists }}" = "true" ]; then
            echo "‚úÖ Archivos XML listos para an√°lisis" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Sin archivos XML - verificar el proceso de preservaci√≥n" >> $GITHUB_STEP_SUMMARY
          fi

  # Tercer oficio: Invocar las artes de la inteligencia artificial
  ai-analysis:
    name: ü§ñ An√°lisis por las Artes de la IA
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data]
    permissions:
      contents: read
      models: read
    outputs:
      ai-response: ${{ steps.inference.outputs.response }}
    steps:
      - name: Mostrar los resultados de la preparaci√≥n
        run: |
          echo "üìÅ Estado de los pergaminos: ${{ needs.prepare-data.outputs.file-exists }}"
          echo "üß™ Total de pruebas: ${{ needs.build-and-test.outputs.tests-total }}"
          echo "‚ùå Errores: ${{ needs.build-and-test.outputs.tests-errors }}"
          echo "‚ö†Ô∏è Fallos: ${{ needs.build-and-test.outputs.tests-failures }}"
          echo "üìä Cobertura: ${{ needs.build-and-test.outputs.coverage-percentage }}%"
          if [ "${{ needs.prepare-data.outputs.file-exists }}" = "true" ]; then
            echo "‚úÖ Procediendo con el an√°lisis por las artes de la IA"
          else
            echo "‚ö†Ô∏è Analizando mensaje de error con la sabidur√≠a artificial"
          fi
      
      - name: Ejecutar el an√°lisis por las artes de la inteligencia artificial
        id: inference
        uses: actions/ai-inference@v1
        with:
          max-tokens: 8000
          system-prompt: |
            Eres un sabio maestro de las artes del testing y desarrollo de software, versado en los antiguos conocimientos. 
            Analiza los resultados de pruebas JUnit y cobertura de c√≥digo para proporcionar un an√°lisis claro y √∫til,
            usando un lenguaje que mezcle lo t√©cnico con referencias al castellano antiguo.
          prompt: |
            Por los pergaminos sagrados, analiza los siguientes resultados de las pruebas y cobertura del c√≥dice, y proporciona un an√°lisis que incluya:

            1. **üìä Resumen General**: N√∫mero total de pruebas, √©xitos, fallos y tiempo de ejecuci√≥n
            2. **üß™ Pruebas Ejecutadas**: Lista de las principales pruebas que se han realizado  
            3. **üéØ Funcionalidades Probadas**: Qu√© aspectos del sistema han sido validados
            4. **üìà Cobertura de C√≥digo**: An√°lisis de la cobertura actual (${{ needs.build-and-test.outputs.coverage-percentage }}%)
            5. **‚ö° Rendimiento**: Tiempos de ejecuci√≥n y posibles optimizaciones
            6. **‚úÖ Estado del Proyecto**: Calidad general basada en los resultados
            7. **üîß Tecnolog√≠as Detectadas**: Frameworks y herramientas identificadas
            8. **üìù Recomendaciones**: Consejos para mejorar la calidad del c√≥digo

            **M√©tricas extra√≠das:**
            - Total de pruebas: ${{ needs.build-and-test.outputs.tests-total }}
            - Errores: ${{ needs.build-and-test.outputs.tests-errors }}
            - Fallos: ${{ needs.build-and-test.outputs.tests-failures }}
            - Cobertura: ${{ needs.build-and-test.outputs.coverage-percentage }}%

            Mant√©n el an√°lisis en espa√±ol, usa emojis para hacerlo m√°s visual y un tono profesional pero amigable con toques de castellano antiguo.
            
            --- CONTENIDO DE LOS PERGAMINOS DE PRUEBAS ---
            ${{ needs.prepare-data.outputs.xml-content }}
            --- FIN DE LOS PERGAMINOS DE PRUEBAS ---

            --- CONTENIDO DEL PERGAMINO DE COBERTURA ---
            ${{ needs.prepare-data.outputs.coverage-content }}
            --- FIN DEL PERGAMINO DE COBERTURA ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
      - name: Reportar el resultado del an√°lisis de IA
        run: |
          echo "ü§ñ An√°lisis de IA completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "üìä Datos analizados:" >> $GITHUB_STEP_SUMMARY
          echo "- Pruebas totales: ${{ needs.build-and-test.outputs.tests-total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cobertura: ${{ needs.build-and-test.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- Pergaminos procesados: ${{ needs.prepare-data.outputs.file-exists }}" >> $GITHUB_STEP_SUMMARY
          echo "üéØ El an√°lisis detallado ser√° inscrito en la issue correspondiente" >> $GITHUB_STEP_SUMMARY

  # Cuarto oficio: Generar el resumen del flujo de trabajo
  generate-summary:
    name: üìã Generaci√≥n del Resumen Final
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis]
    permissions:
      contents: read
    steps:
      - name: Generar el resumen del flujo de trabajo
        run: |
          echo "## üè∞ Pipeline de An√°lisis con IA - Cr√≥nica de la Ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Estado de los Oficios Realizados:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **build-and-test**: Completado con honor" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **prepare-data**: Los pergaminos han sido preparados" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **ai-analysis**: Las artes de la IA han sido invocadas" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **generate-summary**: Elaborando las cr√≥nicas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä M√©tricas de las Pruebas:" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de pruebas**: ${{ needs.build-and-test.outputs.tests-total }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errores**: ${{ needs.build-and-test.outputs.tests-errors }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fallos**: ${{ needs.build-and-test.outputs.tests-failures }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura de c√≥digo**: ${{ needs.build-and-test.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Estado de los Pergaminos:" >> $GITHUB_STEP_SUMMARY
          echo "- **Pergaminos encontrados**: ${{ needs.prepare-data.outputs.file-exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìù Nota sobre el An√°lisis de IA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El an√°lisis detallado generado por las artes de la inteligencia artificial ha sido inscrito como comentario en la issue #${{ github.event.inputs.issue_number || '7' }}." >> $GITHUB_STEP_SUMMARY

  # Quinto oficio: Inscribir el an√°lisis en las cr√≥nicas de la issue
  comment-on-issue:
    name: üí¨ Inscripci√≥n en las Cr√≥nicas de la Issue
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis, generate-summary]
    permissions:
      issues: write
      contents: read
    steps:
      - name: Preparar el contenido para las cr√≥nicas
        id: prepare-comment
        run: |
          # Determinar el n√∫mero de issue a usar
          ISSUE_NUM="${{ github.event.inputs.issue_number }}"
          if [ -z "$ISSUE_NUM" ] || [ "$ISSUE_NUM" = "" ]; then
            ISSUE_NUM="7"
          fi
          echo "issue-number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "üéØ Preparando la inscripci√≥n para la issue #$ISSUE_NUM" >> $GITHUB_STEP_SUMMARY
          echo "üìù Comentario con an√°lisis de IA ser√° publicado" >> $GITHUB_STEP_SUMMARY
      
      - name: Inscribir en las cr√≥nicas de GitHub
        id: create-comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.prepare-comment.outputs.issue-number }}
          body: |
            ## ü§ñ An√°lisis por las Artes de la Inteligencia Artificial

            ### üìã Informaci√≥n del Flujo de Trabajo:
            - **Flujo**: ${{ github.workflow }}
            - **Ejecuci√≥n**: #${{ github.run_number }}
            - **Pergaminos encontrados**: ${{ needs.prepare-data.outputs.file-exists }}

            ### üìä M√©tricas de las Pruebas:
            - **Total de pruebas**: ${{ needs.build-and-test.outputs.tests-total }}
            - **Errores**: ${{ needs.build-and-test.outputs.tests-errors }}
            - **Fallos**: ${{ needs.build-and-test.outputs.tests-failures }}
            - **Cobertura de c√≥digo**: ${{ needs.build-and-test.outputs.coverage-percentage }}%

            ### üßô‚Äç‚ôÇÔ∏è An√°lisis Generado por la IA:

            ${{ needs.ai-analysis.outputs.ai-response }}

            ---
            
            ### üîó Enlaces de utilidad:
            - [Ver ejecuci√≥n completa](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Ver repositorio](${{ github.server_url }}/${{ github.repository }})
            
            *Generado autom√°ticamente por GitHub Actions con las bendiciones de los antiguos maestros*
            
      - name: Confirmar la inscripci√≥n en las cr√≥nicas
        run: |
          echo "‚úÖ Comentario publicado exitosamente en issue #${{ steps.prepare-comment.outputs.issue-number }}" >> $GITHUB_STEP_SUMMARY
          echo "üîó El an√°lisis completo de IA est√° disponible en la issue" >> $GITHUB_STEP_SUMMARY
          echo "üìä M√©tricas incluidas: ${{ needs.build-and-test.outputs.tests-total }} pruebas, ${{ needs.build-and-test.outputs.coverage-percentage }}% cobertura" >> $GITHUB_STEP_SUMMARY

  # Sexto oficio: Finalizaci√≥n y ceremonias de clausura
  finalize:
    name: üéØ Ceremonias de Clausura
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis, generate-summary, comment-on-issue]
    if: always() # Se ejecuta incluso si los oficios anteriores fallan
    permissions:
      contents: read
    steps:
      - name: Estado final del flujo de trabajo
        run: |
          echo "üéâ Pipeline de an√°lisis por IA completado con los honores debidos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä Estado de los oficios realizados:" >> $GITHUB_STEP_SUMMARY
          echo "- build-and-test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- prepare-data: ${{ needs.prepare-data.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ai-analysis: ${{ needs.ai-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- generate-summary: ${{ needs.generate-summary.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- comment-on-issue: ${{ needs.comment-on-issue.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determinar el n√∫mero de issue utilizado
          ISSUE_USED="${{ github.event.inputs.issue_number }}"
          if [ -z "$ISSUE_USED" ] || [ "$ISSUE_USED" = "" ]; then
            ISSUE_USED="7"
          fi
          
          if [ "${{ needs.ai-analysis.result }}" = "success" ]; then
            echo "‚úÖ Las artes de la IA han sido invocadas con √©xito" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Error en la invocaci√≥n de las artes de la IA" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.comment-on-issue.result }}" = "success" ]; then
            echo "‚úÖ Cr√≥nicas inscritas exitosamente en la issue #$ISSUE_USED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Error al inscribir en las cr√≥nicas de la issue #$ISSUE_USED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üèÜ **Resumen Final:**" >> $GITHUB_STEP_SUMMARY
          echo "- Issue utilizada: #$ISSUE_USED" >> $GITHUB_STEP_SUMMARY
          echo "- Pruebas ejecutadas: ${{ needs.build-and-test.outputs.tests-total }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cobertura alcanzada: ${{ needs.build-and-test.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- Pipeline status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Pipeline de an√°lisis completado por los antiguos maestros üßô‚Äç‚ôÇÔ∏è"
