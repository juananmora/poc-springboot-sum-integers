# Este flujo de trabajo construye un proyecto Java con Maven y utiliza la sabidurÃ­a de los antiguos para el anÃ¡lisis
# Por medio de las artes de la inteligencia artificial, se examinan los frutos de las pruebas
# Y se deja constancia de los hallazgos en las crÃ³nicas del repositorio

name: AnÃ¡lisis de Calidad con Maven e IA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'NÃºmero de la issue donde comentar el anÃ¡lisis'
        required: false
        default: '1'
        type: string

jobs:
  # Primer oficio: Forjar el cÃ³digo y ejecutar las pruebas sagradas
  build-and-test:
    name: ğŸ”¨ ConstrucciÃ³n y Pruebas del CÃ³dice
    runs-on: ubuntu-latest
    outputs:
      tests-total: ${{ steps.extract-metrics.outputs.tests-total }}
      tests-errors: ${{ steps.extract-metrics.outputs.tests-errors }}
      tests-failures: ${{ steps.extract-metrics.outputs.tests-failures }}
      coverage-percentage: ${{ steps.extract-coverage.outputs.coverage }}

    steps:
    - name: Obtener los pergaminos del repositorio
      uses: actions/checkout@v4

    - name: Preparar las herramientas de Java, como los antiguos maestros
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Forjar con Maven y ejecutar las pruebas de la sabidurÃ­a
      run: mvn clean test

    - name: Extraer las mÃ©tricas de las pruebas realizadas
      id: extract-metrics
      run: |
        total=$(grep -o 'tests="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        errors=$(grep -o 'errors="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        failures=$(grep -o 'failures="[0-9]\+"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
        echo "tests-total=$total" >> $GITHUB_OUTPUT
        echo "tests-errors=$errors" >> $GITHUB_OUTPUT
        echo "tests-failures=$failures" >> $GITHUB_OUTPUT
        failed=$((errors + failures))
        if [ "$total" -eq 0 ]; then
          echo "âŒ No se hallaron pruebas en los pergaminos."
          exit 1
        fi
        percent=$((100 * failed / total))
        echo "ğŸ§ª Errores y fallos: $failed de $total pruebas ($percent%)"
        if [ "$percent" -gt 10 ]; then
          echo "âš ï¸ El porcentaje de errores supera el lÃ­mite establecido por los antiguos sabios (10%)."
          exit 1
        fi

    - name: Generar el reporte de cobertura con las artes de Jacoco
      run: mvn jacoco:report

    - name: Extraer la cobertura de cÃ³digo
      id: extract-coverage
      run: |
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          coverage=$(grep -o 'type="INSTRUCTION".*counter' target/site/jacoco/jacoco.xml | grep -o 'covered="[0-9]\+"' | head -1 | grep -o '[0-9]\+')
          total=$(grep -o 'type="INSTRUCTION".*counter' target/site/jacoco/jacoco.xml | grep -o 'missed="[0-9]\+"' | head -1 | grep -o '[0-9]\+')
          if [ -n "$coverage" ] && [ -n "$total" ]; then
            percent=$((100 * coverage / (coverage + total)))
            echo "coverage=$percent" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Cobertura de cÃ³digo: $percent%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
        fi

    - name: Preservar los resultados de las pruebas para la posteridad
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: resultados-pruebas-y-cobertura
        path: |
          target/surefire-reports/
          target/site/jacoco/

    - name: Generar la insignia de Jacoco como los heraldos de antaÃ±o
      uses: cicirello/jacoco-badge-generator@v2
      with:
        jacoco-report-path: target/site/jacoco/jacoco.xml
        badges-directory: .github/badges

    - name: Grabar la insignia en los anales del repositorio
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git add .github/badges/jacoco.svg
        git commit -m "Actualiza insignia de cobertura Jacoco [skip ci]" || echo "Sin cambios en las insignias"
        git push || echo "No hay cambios para inscribir"

  # Segundo oficio: Preparar los datos para el anÃ¡lisis de la IA
  prepare-data:
    name: ğŸ“œ PreparaciÃ³n de los Pergaminos
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
    outputs:
      xml-content: ${{ steps.read-xml.outputs.XML_CONTENT }}
      coverage-content: ${{ steps.read-coverage.outputs.COVERAGE_CONTENT }}
      file-exists: ${{ steps.check-files.outputs.exists }}
    steps:
      - name: Obtener los pergaminos del repositorio
        uses: actions/checkout@v4
      
      - name: Descargar los artefactos de las pruebas
        uses: actions/download-artifact@v4
        with:
          name: resultados-pruebas-y-cobertura
          path: resultados/
      
      - name: Verificar la existencia de los pergaminos de pruebas
        id: check-files
        run: |
          if [ -f "resultados/TEST-*.xml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Pergaminos de pruebas hallados"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Pergaminos de pruebas extraviados"
          fi
      
      - name: Leer el contenido de los pergaminos XML
        id: read-xml
        run: |
          if ls resultados/TEST-*.xml 1> /dev/null 2>&1; then
            {
              echo "XML_CONTENT<<DELIMITER"
              cat resultados/TEST-*.xml
              echo "DELIMITER"
            } >> $GITHUB_OUTPUT
          else
            echo "XML_CONTENT=No se encontraron pergaminos de pruebas" >> $GITHUB_OUTPUT
          fi

      - name: Leer el contenido del reporte de cobertura
        id: read-coverage
        run: |
          if [ -f "resultados/jacoco.xml" ]; then
            {
              echo "COVERAGE_CONTENT<<DELIMITER"
              cat resultados/jacoco.xml
              echo "DELIMITER"
            } >> $GITHUB_OUTPUT
          else
            echo "COVERAGE_CONTENT=No se encontrÃ³ el pergamino de cobertura" >> $GITHUB_OUTPUT
          fi

  # Tercer oficio: Invocar las artes de la inteligencia artificial
  ai-analysis:
    name: ğŸ¤– AnÃ¡lisis por las Artes de la IA
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data]
    permissions:
      contents: read
      models: read
    outputs:
      ai-response: ${{ steps.inference.outputs.response }}
    steps:
      - name: Mostrar los resultados de la preparaciÃ³n
        run: |
          echo "ğŸ“ Estado de los pergaminos: ${{ needs.prepare-data.outputs.file-exists }}"
          echo "ğŸ§ª Total de pruebas: ${{ needs.build-and-test.outputs.tests-total }}"
          echo "âŒ Errores: ${{ needs.build-and-test.outputs.tests-errors }}"
          echo "âš ï¸ Fallos: ${{ needs.build-and-test.outputs.tests-failures }}"
          echo "ğŸ“Š Cobertura: ${{ needs.build-and-test.outputs.coverage-percentage }}%"
          if [ "${{ needs.prepare-data.outputs.file-exists }}" = "true" ]; then
            echo "âœ… Procediendo con el anÃ¡lisis por las artes de la IA"
          else
            echo "âš ï¸ Analizando mensaje de error con la sabidurÃ­a artificial"
          fi
      
      - name: Ejecutar el anÃ¡lisis por las artes de la inteligencia artificial
        id: inference
        uses: actions/ai-inference@v1
        with:
          max-tokens: 4000
          system-prompt: |
            Eres un sabio maestro de las artes del testing y desarrollo de software, versado en los antiguos conocimientos. 
            Analiza los resultados de pruebas JUnit y cobertura de cÃ³digo para proporcionar un anÃ¡lisis claro y Ãºtil,
            usando un lenguaje que mezcle lo tÃ©cnico con referencias al castellano antiguo.
          prompt: |
            Por los pergaminos sagrados, analiza los siguientes resultados de las pruebas y cobertura del cÃ³dice, y proporciona un anÃ¡lisis que incluya:

            1. **ğŸ“Š Resumen General**: NÃºmero total de pruebas, Ã©xitos, fallos y tiempo de ejecuciÃ³n
            2. **ğŸ§ª Pruebas Ejecutadas**: Lista de las principales pruebas que se han realizado  
            3. **ğŸ¯ Funcionalidades Probadas**: QuÃ© aspectos del sistema han sido validados
            4. **ğŸ“ˆ Cobertura de CÃ³digo**: AnÃ¡lisis de la cobertura actual (${{ needs.build-and-test.outputs.coverage-percentage }}%)
            5. **âš¡ Rendimiento**: Tiempos de ejecuciÃ³n y posibles optimizaciones
            6. **âœ… Estado del Proyecto**: Calidad general basada en los resultados
            7. **ğŸ”§ TecnologÃ­as Detectadas**: Frameworks y herramientas identificadas
            8. **ğŸ“ Recomendaciones**: Consejos para mejorar la calidad del cÃ³digo

            **MÃ©tricas extraÃ­das:**
            - Total de pruebas: ${{ needs.build-and-test.outputs.tests-total }}
            - Errores: ${{ needs.build-and-test.outputs.tests-errors }}
            - Fallos: ${{ needs.build-and-test.outputs.tests-failures }}
            - Cobertura: ${{ needs.build-and-test.outputs.coverage-percentage }}%

            MantÃ©n el anÃ¡lisis en espaÃ±ol, usa emojis para hacerlo mÃ¡s visual y un tono profesional pero amigable con toques de castellano antiguo.
            
            --- CONTENIDO DE LOS PERGAMINOS DE PRUEBAS ---
            ${{ needs.prepare-data.outputs.xml-content }}
            --- FIN DE LOS PERGAMINOS DE PRUEBAS ---

            --- CONTENIDO DEL PERGAMINO DE COBERTURA ---
            ${{ needs.prepare-data.outputs.coverage-content }}
            --- FIN DEL PERGAMINO DE COBERTURA ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # Cuarto oficio: Generar el resumen del flujo de trabajo
  generate-summary:
    name: ğŸ“‹ GeneraciÃ³n del Resumen Final
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis]
    permissions:
      contents: read
    steps:
      - name: Generar el resumen del flujo de trabajo
        run: |
          echo "## ğŸ° Pipeline de AnÃ¡lisis con IA - CrÃ³nica de la EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Estado de los Oficios Realizados:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **build-and-test**: Completado con honor" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **prepare-data**: Los pergaminos han sido preparados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ai-analysis**: Las artes de la IA han sido invocadas" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **generate-summary**: Elaborando las crÃ³nicas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š MÃ©tricas de las Pruebas:" >> $GITHUB_STEP_SUMMARY
          echo "- **Total de pruebas**: ${{ needs.build-and-test.outputs.tests-total }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errores**: ${{ needs.build-and-test.outputs.tests-errors }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fallos**: ${{ needs.build-and-test.outputs.tests-failures }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura de cÃ³digo**: ${{ needs.build-and-test.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Estado de los Pergaminos:" >> $GITHUB_STEP_SUMMARY
          echo "- **Pergaminos encontrados**: ${{ needs.prepare-data.outputs.file-exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¤– AnÃ¡lisis por las Artes de la Inteligencia Artificial" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.ai-analysis.outputs.ai-response }}" >> $GITHUB_STEP_SUMMARY

  # Quinto oficio: Inscribir el anÃ¡lisis en las crÃ³nicas de la issue
  comment-on-issue:
    name: ğŸ’¬ InscripciÃ³n en las CrÃ³nicas de la Issue
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis, generate-summary]
    permissions:
      issues: write
      contents: read
    if: github.event.inputs.issue_number != ''
    steps:
      - name: Preparar el contenido para las crÃ³nicas
        id: prepare-comment
        run: |
          echo "ğŸ¯ Preparando la inscripciÃ³n para la issue #${{ github.event.inputs.issue_number }}"
      
      - name: Inscribir en las crÃ³nicas de GitHub
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.issue_number }}
          body: |
            ## ğŸ¤– AnÃ¡lisis por las Artes de la Inteligencia Artificial

            ### ğŸ“‹ InformaciÃ³n del Flujo de Trabajo:
            - **Flujo**: ${{ github.workflow }}
            - **EjecuciÃ³n**: #${{ github.run_number }}
            - **Pergaminos encontrados**: ${{ needs.prepare-data.outputs.file-exists }}

            ### ğŸ“Š MÃ©tricas de las Pruebas:
            - **Total de pruebas**: ${{ needs.build-and-test.outputs.tests-total }}
            - **Errores**: ${{ needs.build-and-test.outputs.tests-errors }}
            - **Fallos**: ${{ needs.build-and-test.outputs.tests-failures }}
            - **Cobertura de cÃ³digo**: ${{ needs.build-and-test.outputs.coverage-percentage }}%

            ### ğŸ§™â€â™‚ï¸ AnÃ¡lisis Generado por la IA:

            ${{ needs.ai-analysis.outputs.ai-response }}

            ---
            
            ### ğŸ”— Enlaces de utilidad:
            - [Ver ejecuciÃ³n completa](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Ver repositorio](${{ github.server_url }}/${{ github.repository }})
            
            *Generado automÃ¡ticamente por GitHub Actions con las bendiciones de los antiguos maestros*

  # Sexto oficio: FinalizaciÃ³n y ceremonias de clausura
  finalize:
    name: ğŸ­ Ceremonias de Clausura
    runs-on: ubuntu-latest
    needs: [build-and-test, prepare-data, ai-analysis, generate-summary, comment-on-issue]
    if: always() # Se ejecuta incluso si los oficios anteriores fallan
    permissions:
      contents: read
    steps:
      - name: Estado final del flujo de trabajo
        run: |
          echo "ğŸ‰ Pipeline de anÃ¡lisis por IA completado con los honores debidos"
          echo ""
          echo "ğŸ“Š Estado de los oficios realizados:"
          echo "- build-and-test: ${{ needs.build-and-test.result }}"
          echo "- prepare-data: ${{ needs.prepare-data.result }}"
          echo "- ai-analysis: ${{ needs.ai-analysis.result }}"
          echo "- generate-summary: ${{ needs.generate-summary.result }}"
          echo "- comment-on-issue: ${{ needs.comment-on-issue.result }}"
          echo ""
          if [ "${{ needs.ai-analysis.result }}" = "success" ]; then
            echo "âœ… Las artes de la IA han sido invocadas con Ã©xito"
          else
            echo "âŒ Error en la invocaciÃ³n de las artes de la IA"
          fi
          
          if [ "${{ github.event.inputs.issue_number }}" != "" ]; then
            if [ "${{ needs.comment-on-issue.result }}" = "success" ]; then
              echo "âœ… CrÃ³nicas inscritas en la issue #${{ github.event.inputs.issue_number }}"
            else
              echo "âŒ Error al inscribir en las crÃ³nicas de la issue"
            fi
          else
            echo "â„¹ï¸ No se especificÃ³ nÃºmero de issue para las crÃ³nicas (usando valor por defecto: 1)"
          fi
