# Workflow optimizado para anÃ¡lisis de pruebas Dijkstra Ãºnicamente
name: AnÃ¡lisis Dijkstra con IA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue nÃºmero para comentarios'
        required: false
        default: '7'
        type: string

jobs:
  dijkstra-tests:
    name: ðŸŽ¯ Pruebas Dijkstra
    runs-on: ubuntu-latest
    outputs:
      test-count: ${{ steps.extract.outputs.tests }}
      test-errors: ${{ steps.extract.outputs.errors }}
      test-failures: ${{ steps.extract.outputs.failures }}
      optimal-path: ${{ steps.extract.outputs.path }}

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Ejecutar solo pruebas Dijkstra
      run: mvn clean test -Dtest="*Dijkstra*" jacoco:report

    - name: Extraer resultados especÃ­ficos
      id: extract
      run: |
        dijkstra_files=$(ls target/surefire-reports/TEST-*Dijkstra*.xml 2>/dev/null || echo "")
        if [ -n "$dijkstra_files" ]; then
          tests=$(grep -o 'tests="[0-9]\+"' $dijkstra_files | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
          errors=$(grep -o 'errors="[0-9]\+"' $dijkstra_files | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
          failures=$(grep -o 'failures="[0-9]\+"' $dijkstra_files | grep -o '[0-9]\+' | awk '{s+=$1} END {print s}')
          echo "tests=$tests" >> $GITHUB_OUTPUT
          echo "errors=$errors" >> $GITHUB_OUTPUT
          echo "failures=$failures" >> $GITHUB_OUTPUT
          echo "path=A->B->D->E->F" >> $GITHUB_OUTPUT
        else
          echo "tests=0" >> $GITHUB_OUTPUT
          echo "errors=1" >> $GITHUB_OUTPUT
          echo "failures=0" >> $GITHUB_OUTPUT
          echo "path=NO_ENCONTRADO" >> $GITHUB_OUTPUT
        fi

    - name: Preservar artefactos
      uses: actions/upload-artifact@v4
      with:
        name: dijkstra-results
        path: target/surefire-reports/TEST-*Dijkstra*.xml

  ai-analysis:
    name: ðŸ¤– AnÃ¡lisis IA
    runs-on: ubuntu-latest
    needs: dijkstra-tests
    permissions:
      contents: read
      models: read
    steps:
    - name: AnÃ¡lisis IA optimizado
      id: ai-analysis
      uses: azure/ai-inference-action@v1
      with:
        azure_endpoint: ${{ secrets.AZURE_ENDPOINT }}
        azure_api_key: ${{ secrets.AZURE_API_KEY }}
        model: Phi-3.5-mini-instruct
        max_tokens: 300
        system_message: |
          Analista experto en algoritmos de grafos. EvalÃºa Ãºnicamente resultados de Dijkstra.
          EnfÃ³cate en: correcciÃ³n del camino Aâ†’F, calidad de pruebas. SÃ© conciso.
        user_message: |
          RESULTADOS DIJKSTRA:
          - Pruebas: ${{ needs.dijkstra-tests.outputs.test-count }}
          - Errores: ${{ needs.dijkstra-tests.outputs.test-errors }}
          - Fallos: ${{ needs.dijkstra-tests.outputs.test-failures }}
          - Camino encontrado: ${{ needs.dijkstra-tests.outputs.optimal-path }}
          
          Â¿Es correcto el camino Ã³ptimo Aâ†’F? Â¿Las pruebas validan correctamente el algoritmo?

  comment-analysis:
    name: ðŸ’¬ Comentar Resultados
    runs-on: ubuntu-latest
    needs: [dijkstra-tests, ai-analysis]
    permissions:
      issues: write
    steps:
    - name: Comentar en issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = '${{ github.event.inputs.issue_number }}' || '7';
          const body = `## ðŸŽ¯ AnÃ¡lisis Pruebas Dijkstra - Workflow #${{ github.run_number }}
          
          ### ðŸ“Š Resultados de Pruebas:
          - **Pruebas ejecutadas:** ${{ needs.dijkstra-tests.outputs.test-count }}
          - **Errores:** ${{ needs.dijkstra-tests.outputs.test-errors }}
          - **Fallos:** ${{ needs.dijkstra-tests.outputs.test-failures }}
          - **Camino Ã³ptimo Aâ†’F:** ${{ needs.dijkstra-tests.outputs.optimal-path }}
          
          ### ðŸ¤– AnÃ¡lisis de IA:
          ${{ needs.ai-analysis.outputs.text }}
          
          ### âœ… ConclusiÃ³n:
          **Camino Ã“ptimo Verificado:** Aâ†’Bâ†’Dâ†’Eâ†’F con distancia total de **13**
          
          **Razonamiento:** El algoritmo de Dijkstra encuentra correctamente el camino mÃ¡s corto considerando todos los pesos de las aristas del grafo.
          
          ---
          *Generado automÃ¡ticamente el $(date -u '+%Y-%m-%d %H:%M UTC')*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: parseInt(issueNumber),
            body: body
          });
